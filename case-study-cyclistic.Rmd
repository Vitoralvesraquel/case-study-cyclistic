---
title: "Case Study Cyclistic"
author: "Vitor Alves Raquel"
date: '2022-06-08'
output: html_document
---

# case-study-cyclistic

Case study for Google Data Analytics Certificate's capstone project.

### Initial considerations

Annual members are much more profitable than casual riders.

The insights from the analysis could clarify the differences between annual members and casual riders to design marketing strategies aimed at converting casual riders into annual members.

Customers who purchase single-ride or full-day passes are referred to as casual riders. Customers who purchase annual memberships are Cyclistic members.

Understand how do annual members and casual riders use Cyclistic bikes differently. 

### Data

```{r message=FALSE}
setwd("/home/vitor/RStudio-projects/case-study-cyclistic")
Sys.setlocale("LC_ALL", "C")
```


The original data is available at: https://divvy-tripdata.s3.amazonaws.com/index.html
The data licence can be found here: https://ride.divvybikes.com/data-license-agreement

The data was collected by the company and was organized for this analysis in a directory to keep the original data unchanged. Each month has a subdirectory 
containing a CSV file, comprehending the last 12 months, from June 2021 to May 
2022.

![Directory structure](directory_structure.png)


### Process Data

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(lubridate)
library(mapview)
```

Make a list of the csv files inside the directory with original data.
Apply read_csv function to all files in the list.

```{r message=FALSE}
full_df_list <- list.files(path = "Data/Original", pattern = ".csv", 
                      full.names = TRUE, recursive = TRUE) %>% 
    lapply(read_csv)
```

Count total number of rows in the list.

```{r}
sum_rows_list <- sum(sapply(full_df_list, nrow))
sum_rows_list
```

Combine all data from the list. Compare the number of rows in the list with the
number of rows in the new dataframe to verify that all rows were combined.

```{r}
full_df <- bind_rows(full_df_list)
sum_rows_list == nrow(full_df)

```
Remove list from memory since it will not be used from now on.
```{r}
rm(full_df_list)
```

View columns data types and first rows.

```{r}
glimpse(full_df)
```
Check for NAs.

```{r}
colSums(is.na(full_df))
```
Count unique values for ride_id and compare with number of rows to check for 
duplicates.

```{r}
length(unique(full_df$ride_id)) == sum_rows_list
```


Create columns for trip duration, month_year, day, weekday.

```{r}
full_df <- full_df %>% 
    mutate(trip_duration = as.duration(ended_at - started_at),
           month_year = format(started_at, "%Y-%m"),
           day = day(started_at),
           weekday = wday(started_at, label = TRUE))
unique(full_df$month_year)
```


View data summary to check for anything unusual.

```{r}
summary(full_df)
```

The trip duration column shows some problems. The minimum value is negative and 
maximum is in weeks, which is too big. 
Values smaller than 1 minute will also be disconsidered, since they could represent false starts.
Values larger than 1 day will also be discarded.

```{r}
full_df <- full_df[full_df$trip_duration > 60 & full_df$trip_duration < 86400,]
summary(full_df$trip_duration)
```


Create plots comparing members and casual users.

comparing trip count

```{r}
ggplot(data = full_df) +
    geom_bar(fill = "blue", width = 0.5, mapping = aes(x = member_casual))
```

```{r}
ggplot(data = full_df) +
    geom_bar(position = position_dodge2(width = 1)
             , width = 0.8, mapping = aes(x = weekday, fill = member_casual))
```

On weekends there is a higher amount of casual riders' trips than members', 
while on weekdays there is a higher count on members' trips.
This suggests that members use bikes while commuting.

This can be further explored by comparing the time of the day when trips happen 
for both groups. The ended_at, time when trip ends, would reflect the starting 
work hour, while started_at, the time when work ends.

```{r}
weekday_plot <- ggplot(data = full_df) +
    geom_histogram(position = position_dodge(), bins = 24) +
        facet_wrap("weekday")

weekday_plot + 
    aes(x = hms::as_hms(ended_at), fill = member_casual)
```

```{r}
weekday_plot + 
    aes(x = hms::as_hms(started_at), fill = member_casual)
```



```{r}
ggplot(data = full_df) +
    geom_histogram(position = position_dodge(),
             mapping = aes(x = ended_at, fill = member_casual))
```

```{r}
glimpse(full_df)
```


```{r}
month_plot <- ggplot(data = full_df) +
    geom_bar(position = position_dodge2()) +
    facet_wrap("month_year")

month_plot + 
    aes(x = day, fill = member_casual)
```



analyze duration
```{r}
ggplot(data = full_df[full_df$trip_duration < 3600,]) +
    geom_histogram(position = position_dodge()) +
    aes(x = trip_duration, fill = member_casual)
    
```

```{r}
summary(full_df)
```


analyze geographical coordinates

```{r}
set.seed(111)

to_map_df <- sample_n(full_df, 1000)

mapview(to_map_df, xcol = "start_lng", ycol = "start_lat", crs = 4269, 
        grid = FALSE)

```

